<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>An Example of using the Causal Inference Assistant (CIA) • cia</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="An Example of using the Causal Inference Assistant (CIA)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cia</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/three_node_example.html">An Example of using the Causal Inference Assistant (CIA)</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/SpaceOdyssey/cia/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>An Example of using the Causal Inference Assistant (CIA)</h1>
                        <h4 data-toc-skip class="author">Mathew
Varidel</h4>
            
            <h4 data-toc-skip class="date">30 October, 2024</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/SpaceOdyssey/cia/blob/main/vignettes/three_node_example.Rmd" class="external-link"><code>vignettes/three_node_example.Rmd</code></a></small>
      <div class="d-none name"><code>three_node_example.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="what-is-this-for">What is this for?<a class="anchor" aria-label="anchor" href="#what-is-this-for"></a>
</h2>
<p>This shows the basic usage of the Causal Inference Assistant (cia)
for a simple three node problem, where we can calculate the
probabilities of each DAG analytically.</p>
</div>
<div class="section level2">
<h2 id="causal-structure-learning">Causal structure learning<a class="anchor" aria-label="anchor" href="#causal-structure-learning"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://spaceodyssey.github.io/cia/">cia</a></span><span class="op">)</span></span></code></pre></div>
<p>Create conditional probability tables for the true DAG. This draws
samples from a DAG where <span class="math inline">\(A\)</span> and
<span class="math inline">\(C\)</span> have a common cause <span class="math inline">\(B\)</span>, given by <span class="math inline">\(A
\leftarrow B \rightarrow C\)</span>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">n</span>, <span class="st">'numeric'</span><span class="op">)</span></span>
<span><span class="va">n_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">b</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">c</span><span class="op">[</span><span class="va">b</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n_b</span>, <span class="fl">1</span>, <span class="fl">0.33</span><span class="op">)</span></span>
<span><span class="va">c</span><span class="op">[</span><span class="va">b</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="va">n_b</span>, <span class="fl">1</span>, <span class="fl">0.9</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">n</span>, <span class="st">'numeric'</span><span class="op">)</span></span>
<span><span class="va">a</span><span class="op">[</span><span class="va">b</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n_b</span>, <span class="fl">1</span>, <span class="fl">0.67</span><span class="op">)</span></span>
<span><span class="va">a</span><span class="op">[</span><span class="va">b</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="va">n_b</span>, <span class="fl">1</span>, <span class="fl">0.33</span><span class="op">)</span></span>
<span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">a</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">'yes'</span>, <span class="st">'no'</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">b</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">'yes'</span>, <span class="st">'no'</span><span class="op">)</span></span>
<span><span class="va">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">c</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">'yes'</span>, <span class="st">'no'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span>, B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span>, C <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">A</th>
<th align="left">B</th>
<th align="left">C</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">no</td>
<td align="left">no</td>
<td align="left">yes</td>
</tr>
<tr class="even">
<td align="left">yes</td>
<td align="left">no</td>
<td align="left">yes</td>
</tr>
<tr class="odd">
<td align="left">yes</td>
<td align="left">yes</td>
<td align="left">no</td>
</tr>
<tr class="even">
<td align="left">yes</td>
<td align="left">yes</td>
<td align="left">no</td>
</tr>
<tr class="odd">
<td align="left">yes</td>
<td align="left">no</td>
<td align="left">yes</td>
</tr>
<tr class="even">
<td align="left">yes</td>
<td align="left">yes</td>
<td align="left">no</td>
</tr>
</tbody>
</table>
<p>Let’s calculate the correlation matrix to get an idea of the marginal
dependencies in the data. This suggests that (<span class="math inline">\(A\)</span>, <span class="math inline">\(B\)</span>, <span class="math inline">\(C\)</span>) are marginally dependent which is what
you would expect for the DAG that we are studying.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">dat</span> <span class="op">==</span> <span class="st">'yes'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left"></th>
<th align="right">A</th>
<th align="right">B</th>
<th align="right">C</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">A</td>
<td align="right">1.0000000</td>
<td align="right">0.5192308</td>
<td align="right">-0.3397902</td>
</tr>
<tr class="even">
<td align="left">B</td>
<td align="right">0.5192308</td>
<td align="right">1.0000000</td>
<td align="right">-0.7091273</td>
</tr>
<tr class="odd">
<td align="left">C</td>
<td align="right">-0.3397902</td>
<td align="right">-0.7091273</td>
<td align="right">1.0000000</td>
</tr>
</tbody>
</table>
<div class="section level3">
<h3 id="calculate-analytical-probabilities-for-each-graph">Calculate analytical probabilities for each graph<a class="anchor" aria-label="anchor" href="#calculate-analytical-probabilities-for-each-graph"></a>
</h3>
<p>Get all possible graphs.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">GetAllDAGs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">nodes</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nodes</span><span class="op">)</span></span>
<span>  <span class="va">n_tri</span> <span class="op">&lt;-</span> <span class="va">n</span><span class="op">*</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span></span>
<span>  <span class="va">tri_comb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0L</span>, <span class="fl">1L</span><span class="op">)</span><span class="op">)</span>, <span class="va">n_tri</span><span class="op">)</span></span>
<span>  <span class="va">tri_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span><span class="va">tri_comb</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">node_perm</span> <span class="op">&lt;-</span> <span class="fu">gtools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gtools/man/combinations.html" class="external-link">permutations</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nodes</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nodes</span><span class="op">)</span>, <span class="va">nodes</span><span class="op">)</span></span>
<span>  <span class="va">all_dags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">node_perm</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">tri_val</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>        <span class="fl">0L</span>,</span>
<span>        nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nodes</span><span class="op">)</span>, </span>
<span>        ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nodes</span><span class="op">)</span>,</span>
<span>        dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">node_perm</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span>, <span class="va">node_perm</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="va">mat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">upper.tri</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">tri_val</span><span class="op">[</span><span class="va">j</span>, <span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">mat</span> <span class="op">&lt;-</span> <span class="va">mat</span><span class="op">[</span><span class="va">nodes</span>, <span class="va">nodes</span><span class="op">]</span></span>
<span>      </span>
<span>      <span class="va">all_dags</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">mat</span></span>
<span>      <span class="va">n</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">all_dags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">all_dags</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">all_dags</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="va">all_dags</span> <span class="op">&lt;-</span> <span class="fu">GetAllDAGs</span><span class="op">(</span><span class="va">nodes</span><span class="op">)</span></span></code></pre></div>
<p>Score all possible DAGs against the simulated data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scorer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CreateScorer.html">CreateScorer</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dat</span>, type <span class="op">=</span> <span class="st">'bde'</span>, cache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">score_all_dags</span> <span class="op">&lt;-</span> <span class="va">all_dags</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">ScoreDAG</span>, scorer <span class="op">=</span> <span class="va">scorer</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">hash_all_dags</span> <span class="op">&lt;-</span> <span class="va">all_dags</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">rlang</span><span class="fu">::</span><span class="va"><a href="https://rlang.r-lib.org/reference/hash.html" class="external-link">hash</a></span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Convert the scores into expected probabilities.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">score_all_dags</span><span class="op">)</span></span>
<span><span class="va">log_z</span> <span class="op">&lt;-</span> <span class="va">x_max</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">score_all_dags</span> <span class="op">-</span> <span class="va">x_max</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">log_p</span> <span class="op">&lt;-</span> <span class="va">score_all_dags</span> <span class="op">-</span> <span class="va">log_z</span></span>
<span><span class="va">p_true</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_p</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  hash_dag <span class="op">=</span> <span class="va">hash_all_dags</span>, </span>
<span>  p_true <span class="op">=</span> <span class="va">p_true</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="sample-from-the-posterior-using-mcmc">Sample from the posterior using MCMC<a class="anchor" aria-label="anchor" href="#sample-from-the-posterior-using-mcmc"></a>
</h3>
<p>Let’s sample from the posterior using the cia implementation of
partition MCMC (Kuipers &amp; Moffa, 2017). Below I sample two chains,
so that we can compare the between chain convergence of estimated
quantities. Typically, we would suggest running four chains by default
(Vehtari et al., 2021).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">n_results</span> <span class="op">&lt;-</span> <span class="fl">20000</span></span>
<span><span class="va">n_chains</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span></span>
<span><span class="va">init_partitions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_chains</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">init_dag</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/UniformlySampleDAG.html">UniformlySampleDAG</a></span><span class="op">(</span><span class="va">nodes</span><span class="op">)</span></span>
<span>  <span class="va">init_partitions</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/DAGtoPartition.html">DAGtoPartition</a></span><span class="op">(</span><span class="va">init_dag</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loading required namespace: igraph</span></span></code></pre></div>
<p>For the sampling below I will only use the move-node proposal. There
are some minor issues with following detailed balance by using the
others. The details of this will be ignored for now.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SampleChains.html">SampleChains</a></span><span class="op">(</span><span class="va">n_results</span>,</span>
<span>                       <span class="va">init_partitions</span>,</span>
<span>                       transition <span class="op">=</span> <span class="fu"><a href="../reference/PartitionMCMC.html">PartitionMCMC</a></span><span class="op">(</span></span>
<span>                         proposal <span class="op">=</span> <span class="fu"><a href="../reference/DefaultProposal.html">DefaultProposal</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">1.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">0.0</span><span class="op">)</span><span class="op">)</span></span>
<span>                         <span class="op">)</span>,</span>
<span>                       scorer <span class="op">=</span> <span class="va">scorer</span>,</span>
<span>                       n_parallel_chains <span class="op">=</span> <span class="va">n_chains</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="analysing-the-mcmc-chains-">Analysing the MCMC chains.<a class="anchor" aria-label="anchor" href="#analysing-the-mcmc-chains-"></a>
</h3>
<p>A good way to start your analysis on the chains is to understand it’s
dependency on the initial starting value. This can be done graphically
by plotting the score of both chains. This plot is often referred to as
the score trace.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/PlotScoreTrace.html">PlotScoreTrace</a></span><span class="op">(</span><span class="va">chains</span>, ylab <span class="op">=</span> <span class="st">'log(partition score)'</span>, type <span class="op">=</span> <span class="st">'l'</span><span class="op">)</span></span></code></pre></div>
<p><img src="three_node_example_files/figure-html/unnamed-chunk-9-1.png" width="576"></p>
<p>The graph suggests that PMCMC spends a number of steps at the start
of the chains to converge to a stable point. This is called the burnin
and should be removed. I remove 500 steps as a burnin and plot the trace
again.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_burnin</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">eq_chains</span> <span class="op">&lt;-</span> <span class="va">chains</span><span class="op">[</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">n_burnin</span><span class="op">)</span><span class="op">:</span><span class="va">n_results</span><span class="op">]</span></span>
<span><span class="fu"><a href="../reference/PlotScoreTrace.html">PlotScoreTrace</a></span><span class="op">(</span><span class="va">eq_chains</span>, ylab <span class="op">=</span> <span class="st">'log(partition score)'</span>, type <span class="op">=</span> <span class="st">'l'</span><span class="op">)</span></span></code></pre></div>
<p><img src="three_node_example_files/figure-html/unnamed-chunk-10-1.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="qualitatively-check-the-dag-score-chains-for-convergence">Qualitatively check the DAG score chains for convergence<a class="anchor" aria-label="anchor" href="#qualitatively-check-the-dag-score-chains-for-convergence"></a>
</h3>
<p>The above suggests that the chains have converged with respect to the
partition score. However, we want to study DAGs, so let’s convert the
partitions to DAGs and then see if the DAG score has converged.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eq_dag_chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PartitiontoDAG.html">PartitiontoDAG</a></span><span class="op">(</span><span class="va">eq_chains</span>, <span class="va">scorer</span><span class="op">)</span></span></code></pre></div>
<p>Plot trace of DAG scores for equilibrium states.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/PlotScoreTrace.html">PlotScoreTrace</a></span><span class="op">(</span><span class="va">eq_dag_chains</span>, attribute <span class="op">=</span> <span class="st">'log_score'</span>, ylab <span class="op">=</span> <span class="st">'log(DAG score)'</span>, type <span class="op">=</span> <span class="st">'l'</span><span class="op">)</span></span></code></pre></div>
<p><img src="three_node_example_files/figure-html/unnamed-chunk-12-1.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="quantitatively-check-the-convergence-of-the-score-trace">Quantitatively check the convergence of the score trace<a class="anchor" aria-label="anchor" href="#quantitatively-check-the-convergence-of-the-score-trace"></a>
</h3>
<p>On inspection the score trace for both partitions and DAGs appears to
have converged across chains. We can also use quantitative measures,
such as the the Split R-hat convergence statistic and the the effective
sample size S_eff (Gelman et al., 2013; Vehtari et al., 2021). We can do
this for the log-score of the partitions:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">eq_chains</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">stats</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">Mean</th>
<th align="right">SD</th>
<th align="right">MCSE</th>
<th align="right">S_eff</th>
<th align="right">R_hat</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">-175.5264</td>
<td align="right">0.5008356</td>
<td align="right">0.0056417</td>
<td align="right">7880.835</td>
<td align="right">1.000041</td>
</tr></tbody>
</table>
<p>This can also be performed for the log DAG scores.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">eq_dag_chains</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">stats</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">Mean</th>
<th align="right">SD</th>
<th align="right">MCSE</th>
<th align="right">S_eff</th>
<th align="right">R_hat</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">-175.5604</td>
<td align="right">0.6141565</td>
<td align="right">0.0058787</td>
<td align="right">10914.22</td>
<td align="right">1.000044</td>
</tr></tbody>
</table>
<p>The Split R-hat statistic provides a measure of the convergence of
the chains (Gelman et al., 2013). R-hat values closer to 1 are
considered to have greater evidence for convergence, with the latest
recommendations suggesting to aim for R-hat &lt; 1.01 (Vehtari et al.,
2021). The R_hat should only be relied upon when the total effective
sample size across the chains is S_eff &gt; 400 and the average
effective sample size per chain is N_eff &gt; 100.</p>
<p>You can think of the effective sample size as the approximate number
of independent samples from the posterior distribution you have for the
quantity of interest. If you’re just reporting the mean and/or the
standard deviation of a parameter, then Vehtari et al. (2021) suggest
that that the total effective sample size should be greater than 400. If
you want to report quantiles (e.g., 95% credible intervals) the
effective sample size may need to be on the order of thousands of
samples to constrain the tail of the distribution (e.g., Kruschke,
2021).</p>
<p>As a caveat to the above, note that these recommendations are adapted
from other applications of MCMCs, typically for estimating parameters
that are continuous variables. Further research needs to be undertaken
to be sure that this applies to sampling of DAGs and derived
quantities.</p>
</div>
<div class="section level3">
<h3 id="analysing-acceptance-rates">Analysing acceptance rates<a class="anchor" aria-label="anchor" href="#analysing-acceptance-rates"></a>
</h3>
<p>It’s often a good idea to check the proposal acceptance rates. For
most problems where an MCMC is applied the acceptance rates should be in
the region 0.1 to 0.5. Below we calculate the acceptance rates per
chain, and fortunately the acceptance rates are consistent with the
typical MCMC ranges in this case.</p>
<p>We note that in our experience PMCMC acceptance rates can be very
low. This is something that needs to be further investigated. In such
cases, it is important to ensure that the PMCMC is capable of walking
out of local maxima. One way to do this is to check that chains starting
from different locations converge to the same distribution.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">total_accept</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CalculateAcceptanceRates.html">CalculateAcceptanceRates</a></span><span class="op">(</span><span class="va">eq_chains</span>, group_by <span class="op">=</span> <span class="st">'chain'</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">total_accept</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="8%">
<col width="16%">
<col width="25%">
<col width="25%">
<col width="12%">
<col width="11%">
</colgroup>
<thead><tr class="header">
<th align="left">chain</th>
<th align="right">mean_accept</th>
<th align="right">mean_black_obeyed</th>
<th align="right">mean_white_obeyed</th>
<th align="right">n_accept</th>
<th align="right">n_total</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="right">0.1201538</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">2343</td>
<td align="right">19500</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="right">0.1192308</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">2325</td>
<td align="right">19500</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="estimating-probabilities-for-each-dag">Estimating probabilities for each DAG<a class="anchor" aria-label="anchor" href="#estimating-probabilities-for-each-dag"></a>
</h3>
<p>This shows the comparison between the estimated (p_est) and true
(p_true) posterior probabilities for the top five DAGs that were visited
in the sampling procedure. If the sampling procedure has worked well,
then the two values should be approximately equal. Our experiments
suggest that the cia implementation of PMCMC gets within a few percent
of the true posterior probability for the true DAG in this problem.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flat_eq_chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/FlattenChains.html">FlattenChains</a></span><span class="op">(</span><span class="va">eq_dag_chains</span><span class="op">)</span></span>
<span><span class="va">collect_dags</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CollectUniqueObjects.html">CollectUniqueObjects</a></span><span class="op">(</span><span class="va">flat_eq_chains</span><span class="op">)</span></span>
<span><span class="va">p_ordered_dags</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">collect_dags</span><span class="op">$</span><span class="va">log_sampling_prob</span>,</span>
<span>                       decreasing <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                       index.return <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">adj</span> <span class="op">&lt;-</span> <span class="va">collect_dags</span><span class="op">$</span><span class="va">state</span><span class="op">[[</span><span class="va">p_ordered_dags</span><span class="op">$</span><span class="va">ix</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">bn_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/toBNLearn.html">toBNLearn</a></span><span class="op">(</span><span class="va">adj</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bn_obj</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">p_est</span> <span class="op">&lt;-</span> <span class="va">p_ordered_dags</span><span class="op">$</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">p_true</span> <span class="op">&lt;-</span> <span class="va">p_summary</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">hash_dag</span> <span class="op">==</span> <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/hash.html" class="external-link">hash</a></span><span class="op">(</span><span class="va">adj</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">p_true</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">'p_est: '</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">p_est</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>             <span class="st">', p_true: '</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">p_true</span>, <span class="fl">4</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">''</span><span class="op">)</span></span>
<span>  <span class="fu">graphics</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html" class="external-link">text</a></span><span class="op">(</span><span class="fl">300</span>, <span class="fl">0</span>, <span class="va">t</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="three_node_example_files/figure-html/unnamed-chunk-16-1.png" width="50%"><img src="three_node_example_files/figure-html/unnamed-chunk-16-2.png" width="50%"><img src="three_node_example_files/figure-html/unnamed-chunk-16-3.png" width="50%"><img src="three_node_example_files/figure-html/unnamed-chunk-16-4.png" width="50%"><img src="three_node_example_files/figure-html/unnamed-chunk-16-5.png" width="50%"></p>
</div>
</div>
<div class="section level2">
<h2 id="causal-inference-given-the-distribution-of-dags-">Causal inference given the distribution of DAGs.<a class="anchor" aria-label="anchor" href="#causal-inference-given-the-distribution-of-dags-"></a>
</h2>
<p>We can use the posterior distribution of DAGs to estimate a number of
causal estimands of interest.</p>
<div class="section level3">
<h3 id="inferring-direct-causes">Inferring direct causes<a class="anchor" aria-label="anchor" href="#inferring-direct-causes"></a>
</h3>
<p>For example, what nodes directly affect each other. This corresponds
to the propensity of an edge occurring in the posterior sample of
DAGs.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flat_eq_dag_chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/FlattenChains.html">FlattenChains</a></span><span class="op">(</span><span class="va">eq_dag_chains</span><span class="op">)</span> </span>
<span><span class="va">p_edge</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CalculateEdgeProbabilities.html">CalculateEdgeProbabilities</a></span><span class="op">(</span><span class="va">flat_eq_dag_chains</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">p_edge</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left"></th>
<th align="right">A</th>
<th align="right">B</th>
<th align="right">C</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">A</td>
<td align="right">0.0000000</td>
<td align="right">0.3176410</td>
<td align="right">0.0080256</td>
</tr>
<tr class="even">
<td align="left">B</td>
<td align="right">0.6821538</td>
<td align="right">0.0000000</td>
<td align="right">0.6747949</td>
</tr>
<tr class="odd">
<td align="left">C</td>
<td align="right">0.0092821</td>
<td align="right">0.3252051</td>
<td align="right">0.0000000</td>
</tr>
</tbody>
</table>
<p>This can also be represented graphically in what is often referred to
as a consensus graph (e.g., Kuipers et al., 2019; Moffa et al.,
2023).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">qgraph</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/qgraph/man/qgraph.html" class="external-link">qgraph</a></span><span class="op">(</span><span class="va">p_edge</span>, theme <span class="op">=</span> <span class="st">'colorblind'</span><span class="op">)</span></span></code></pre></div>
<p><img src="three_node_example_files/figure-html/unnamed-chunk-18-1.png" width="480"></p>
<p>It is always good practice to check the convergence for all reported
values. This can be done using the convergence and effective sample
statistics mentioned above. In this case, I will also highlight the
other reported value is the Monte Carlo Standard Error (MCSE). This is
an estimate of the MCMC contribution to the uncertainty of the mean.
Running the MCMC for longer will reduce this value. This value should be
reduced to a standard that you are comfortable reporting. As we’re
considering edge probabilities, a natural target is to reduce the error
of the mean to below 1% corresponding to MCSE&lt;0.01.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pedge_sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SampleEdgeProbabilities.html">SampleEdgeProbabilities</a></span><span class="op">(</span><span class="va">eq_dag_chains</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">pedge_sample</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<table class="table kable_wrapper"><tbody><tr>
<td>
<table class="table">
<thead><tr class="header">
<th align="right">Mean</th>
<th align="right">SD</th>
<th align="right">MCSE</th>
<th align="right">S_eff</th>
<th align="right">R_hat</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0.0000000</td>
<td align="right">0.0000000</td>
<td align="right">NaN</td>
<td align="right">NaN</td>
<td align="right">NaN</td>
</tr>
<tr class="even">
<td align="right">0.6821538</td>
<td align="right">0.4656453</td>
<td align="right">0.0099573</td>
<td align="right">2186.893</td>
<td align="right">1.000042</td>
</tr>
<tr class="odd">
<td align="right">0.0092821</td>
<td align="right">0.0958965</td>
<td align="right">0.0008439</td>
<td align="right">12912.373</td>
<td align="right">1.000253</td>
</tr>
<tr class="even">
<td align="right">0.3176410</td>
<td align="right">0.4655650</td>
<td align="right">0.0099598</td>
<td align="right">2185.049</td>
<td align="right">1.000039</td>
</tr>
<tr class="odd">
<td align="right">0.0000000</td>
<td align="right">0.0000000</td>
<td align="right">NaN</td>
<td align="right">NaN</td>
<td align="right">NaN</td>
</tr>
<tr class="even">
<td align="right">0.3252051</td>
<td align="right">0.4684574</td>
<td align="right">0.0093723</td>
<td align="right">2498.344</td>
<td align="right">1.000182</td>
</tr>
<tr class="odd">
<td align="right">0.0080256</td>
<td align="right">0.0892269</td>
<td align="right">0.0007080</td>
<td align="right">15883.083</td>
<td align="right">1.000058</td>
</tr>
<tr class="even">
<td align="right">0.6747949</td>
<td align="right">0.4684574</td>
<td align="right">0.0093723</td>
<td align="right">2498.344</td>
<td align="right">1.000182</td>
</tr>
<tr class="odd">
<td align="right">0.0000000</td>
<td align="right">0.0000000</td>
<td align="right">NaN</td>
<td align="right">NaN</td>
<td align="right">NaN</td>
</tr>
</tbody>
</table>
</td>
</tr></tbody></table>
<p>Qualitative checks are also a good idea to supplement the
quantitative checks. In the below plot each point represents the
marginalised edge probability for a given edge in chain 1 (x) compared
to chain 2 (y). Points that lie close to the x = y line suggest that the
chains have converged. This is referred to as a concordance plot (Suter
et al., 2023).</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_edge</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CalculateEdgeProbabilities.html">CalculateEdgeProbabilities</a></span><span class="op">(</span><span class="va">eq_dag_chains</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/PlotConcordance.html">PlotConcordance</a></span><span class="op">(</span><span class="va">p_edge</span><span class="op">)</span></span></code></pre></div>
<p><img src="three_node_example_files/figure-html/unnamed-chunk-20-1.png" width="480"></p>
<p>Another way to check the convergence is to look at the cumulative
mean over the chains (Suter et al., 2021). This can be performed by
first drawing from the posterior predictive chain, which involves
sampling whether there is an edge per sampling iteration. The cumulative
mean can then be calculated from this chain. Eventually the two chains
for the cumulative mean should stabilise to approximately the same
value. Note that in Suter et al. (2021) they show the within chain
cumulative mean trace, instead we show the the cumulative mean trace per
pairwise edge probability for multiple chains, to check both the within
and between chain convergence.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pedge_sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SampleEdgeProbabilities.html">SampleEdgeProbabilities</a></span><span class="op">(</span><span class="va">eq_dag_chains</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/PlotCumulativeMeanTrace.html">PlotCumulativeMeanTrace</a></span><span class="op">(</span><span class="va">pedge_sample</span>, nrow <span class="op">=</span> <span class="fl">3</span>, ncol <span class="op">=</span> <span class="fl">3</span>, dir <span class="op">=</span> <span class="st">'v'</span><span class="op">)</span></span></code></pre></div>
<p><img src="three_node_example_files/figure-html/unnamed-chunk-21-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="inferring-causes">Inferring causes<a class="anchor" aria-label="anchor" href="#inferring-causes"></a>
</h3>
<p>The edge probability doesn’t correspond to the probability that A is
a cause of B. For that, we must calculate the probability that there is
any directed path from A to B (i.e., A is an ancestor of B). Below, we
will just calculate a point estimate for the ancestor probability for
all node pairs. Convergence and effective sample size checks should be
performed for these values for a complete analysis.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_feature</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dag</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">dagitty_obj</span> <span class="op">&lt;-</span> <span class="va">dag</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/toBNLearn.html">toBNLearn</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dagitty</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dagitty/man/as.dagitty.html" class="external-link">as.dagitty</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">col_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dag</span><span class="op">)</span></span>
<span>  <span class="va">row_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">dag</span><span class="op">)</span></span>
<span>  <span class="va">p_anc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0L</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dag</span><span class="op">)</span>,</span>
<span>                  ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">dag</span><span class="op">)</span>, </span>
<span>                  dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">row_names</span>, <span class="va">col_names</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">effect_node</span> <span class="kw">in</span> <span class="va">col_names</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ancestors</span> <span class="op">&lt;-</span> <span class="fu">dagitty</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dagitty/man/AncestralRelations.html" class="external-link">ancestors</a></span><span class="op">(</span><span class="va">dagitty_obj</span>, <span class="va">effect_node</span>, proper <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">row_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">ancestors</span>, <span class="va">row_names</span><span class="op">)</span></span>
<span>    <span class="va">p_anc</span><span class="op">[</span><span class="va">row_indices</span>, <span class="va">effect_node</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1L</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">p_anc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">flat_eq_dag_chains</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/CalculateFeatureMean.html">CalculateFeatureMean</a></span><span class="op">(</span><span class="va">p_feature</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">3</span>, ncol <span class="op">=</span> <span class="fl">3</span>, dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">nodes</span>, <span class="va">nodes</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left"></th>
<th align="right">A</th>
<th align="right">B</th>
<th align="right">C</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">A</td>
<td align="right">0.0000000</td>
<td align="right">0.3176667</td>
<td align="right">0.3165897</td>
</tr>
<tr class="even">
<td align="left">B</td>
<td align="right">0.6822051</td>
<td align="right">0.0000000</td>
<td align="right">0.6747949</td>
</tr>
<tr class="odd">
<td align="left">C</td>
<td align="right">0.3251026</td>
<td align="right">0.3252051</td>
<td align="right">0.0000000</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="estimating-interventional-distributions">Estimating interventional distributions<a class="anchor" aria-label="anchor" href="#estimating-interventional-distributions"></a>
</h3>
<p>Or, we can estimate the probability distribution given some
intervention. Let’s say the expectation of <span class="math inline">\(A
= yes\)</span> given that we intervene to set <span class="math inline">\(B = yes\)</span>, which is given by, <span class="math display">\[E(A = yes | do(B = yes), D) \approx \sum_{g \in
G} E(A = yes | do(B = yes), g) p(g|D).\]</span> This can be done using a
do-operation (Pearl, 2000) which can be performed by; 1) mutilating the
graph such that all edges into <span class="math inline">\(B\)</span>
have been removed, 2) setting <span class="math inline">\(B=yes\)</span>, and 3) calculating the expectation
of <span class="math inline">\(A=yes\)</span> given this interventional
network. Note that the above approximation doesn’t pass through the
errors in the parameters for a given graph, instead just using the
expectation <span class="math inline">\(E(A = yes | do(B = yes),
g).\)</span></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_AdoB</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dag</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">grain_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/togRain.html">togRain</a></span><span class="op">(</span><span class="va">dag</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span>  <span class="va">mut_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MutilateGraph.html">MutilateGraph</a></span><span class="op">(</span><span class="va">grain_obj</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>B <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>no <span class="op">=</span> <span class="fl">0.0</span>, yes <span class="op">=</span> <span class="fl">1.0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">p_A</span> <span class="op">&lt;-</span> <span class="fu">gRain</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gRain/man/querygrain.html" class="external-link">querygrain</a></span><span class="op">(</span><span class="va">mut_obj</span>, <span class="st">'A'</span><span class="op">)</span><span class="op">$</span><span class="va">A</span><span class="op">[</span><span class="st">'yes'</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">p_A</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">post_AdoB_chains</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SamplePosteriorPredictiveChains.html">SamplePosteriorPredictiveChains</a></span><span class="op">(</span><span class="va">eq_dag_chains</span>, <span class="va">p_AdoB</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span></code></pre></div>
<p>Once again, it’s good practice to check the convergence of the
chains. Let’s do this by using the summary function. This estimated
value can be compared to the true value of 0.5, where the true value
should be within the Mean<span class="math inline">\(\pm 2
\times\)</span>SD 95% of the time.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post_AdoB_summ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">post_AdoB_chains</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">post_AdoB_summ</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">stats</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">Mean</th>
<th align="right">SD</th>
<th align="right">MCSE</th>
<th align="right">S_eff</th>
<th align="right">R_hat</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">0.66431</td>
<td align="right">0.1258206</td>
<td align="right">0.0026917</td>
<td align="right">2185.011</td>
<td align="right">1.000045</td>
</tr></tbody>
</table>
<p>Let’s also look at the convergence using the cumulative mean trace
plots again. Eventually the two chains for the cumulative mean should
stabilise to approximately the same value.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/PlotCumulativeMeanTrace.html">PlotCumulativeMeanTrace</a></span><span class="op">(</span><span class="va">post_AdoB_chains</span><span class="op">)</span></span></code></pre></div>
<p><img src="three_node_example_files/figure-html/unnamed-chunk-25-1.png" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>The above analysis shows the process of performing causal inference
using cia. We first estimated the posterior distribution for the causal
structures using partition MCMC and then estimated causal estimands of
interest, such as the probability that one node is a cause of another
and the mean of an interventional distribution. We also showed how to
check that the sampling has been completed reliably, so that you can
have confidence reporting these estimated values.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Gelman, A., Carlin, J.B., Stern, H.S., Dunson, D.B., Vehtari, A.,
&amp; Rubin, D.B. (2013). Bayesian Data Analysis (3rd ed.). Chapman and
Hall/CRC.</p>
<p>Kruschke, J. K. (2021). Bayesian analysis reporting guidelines.
Nature human behaviour, 5(10), 1282-1291.</p>
<p>Kuipers, J., &amp; Moffa, G. (2017). Partition MCMC for inference on
acyclic digraphs. Journal of the American Statistical Association,
112(517), 282-299.</p>
<p>Kuipers, J., Moffa, G., Kuipers, E., Freeman, D., &amp; Bebbington,
P. (2019). Links between psychotic and neurotic symptoms in the general
population: an analysis of longitudinal British National Survey data
using Directed Acyclic Graphs. Psychological Medicine, 49(3),
388-395.</p>
<p>Moffa, G., Kuipers, J., Kuipers, E., McManus, S., &amp; Bebbington,
P. (2023). Sexual abuse and psychotic phenomena: a directed acyclic
graph analysis of affective symptoms using English national psychiatric
survey data. Psychological medicine, 53(16), 7817-7826.</p>
<p>Pearl, J. (2000). Causality: Models, Reasoning, and Inference.
Cambridge University Press.</p>
<p>Suter, P., Kuipers, J., Moffa, G., &amp; Beerenwinkel, N. (2023).
Bayesian Structure Learning and Sampling of Bayesian Networks with the R
Package BiDAG. Journal of Statistical Software, 105(9), 1–31. <a href="https://doi.org/10.18637/jss.v105.i09" class="external-link uri">https://doi.org/10.18637/jss.v105.i09</a></p>
<p>Vehtari, A., Gelman, A., Simpson, D., Carpenter, B., &amp; Bürkner,
P. C. (2021). Rank-normalization, folding, and localization: An improved
R-hat for assessing convergence of MCMC (with discussion). Bayesian
analysis, 16(2), 667-718.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mathew Varidel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
